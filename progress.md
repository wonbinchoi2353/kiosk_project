# 진행 상황

## 과제 날짜

- 7/25 과제 세팅 및 시작
- 7/26 상품 추가 api
- 7/27 상품 조회, 삭제, 수정 api
- 7/28 상품 발주, 발주 상태 수정 api
- 7/31 상품 주문 api

## API

| NAME           | METHOD   | URL                           |
| -------------- | -------- | ----------------------------- |
| 상품 생성      | `post`   | api/item                      |
| 상품 조회      | `get`    | api/items/?key=value          |
| 상품 삭제      | `delete` | api/item/:item_id             |
| 상품 수정      | `put`    | api/item/:item_id             |
| 상품 발주      | `post`   | api/items/:item_id/order_item |
| 발주 상태 수정 | `put`    | api/items/:item_id/order_item |
| 고객 상품 주문 | `post`   | api/orders                    |

## 빠진 부분

- 아이템 option_id 추가
- 트랜잭션 에러 처리 확인 필요

## 추가 기능

- readline 모듈

## 문제

### 테이블에 따라서 어떤 데이터를 어떤 방식으로 가져오는 게 좋을지

- id는 url을 가져오는 params로 받았다
- 테이블의 주된 데이터들은 보통 body로 받았다
- 간단하게 url에서 가져올 데이터는 query로 받을 수 있다

### 레파지토리 어떻게 구성하면 좋을지

- 각각의 메서드로 구성하는 게 보기에 깔끔해 보여서 모두 나눴다
- 트랜잭션을 하면 여러 메서드를 사용하면서 에러 처리도 해야할 것 같다

### (상품 생성) 서비스의 에러 처리

- 서비스에서 throw new error를 사용해 컨트롤러에서 에러 메세지가 같으면 해당하는 응답을 보냈다. 만약 에러를 수정할 일이 생기면 서비스에 있는 에러 문구와 컨트롤러에 있는 에러 문구를 번거롭게 수정해야하는 단점도 있지만 상태 코드를 에러 메세지에 맞게 보내줄 수 있는 다른 방법을 아직 찾지 못 했다.

### (상품 조회) 전체 조회와 type별로 조회

- 처음엔 body에 type을 요청했는데 쿼리를 알게 되어서 ?type=coffee 처럼 url에 타입이 있으면 타입별로 조회하고 url에 타입이 없으면 전체 조회를 하게 만들었다

### (상품 삭제) readline을 써야할지, 쓰면 어떻게 써야 할지

- 사용자의 의사를 확인 해야 해서 readline을 써보기로 했다. 사용자가 대답한 값을 사용하려면 사용자가 대답을 한 후에 값을 받을 수 있게 반환값을 기다려서 받아야 했다. 그래서 promise를 사용해 사용자가 대답을 한 후에 값을 반환하게 만들었다.

### (상품 발주) enum 타입 state에 데이터가 안 들어가는 문제

- enum 타입을 모델과 마이그레이션에 만들 때 숫자로 만들면 에러가 생겼다. defalultValue 또한 문자열로 ('0') 바꿔줬다.
- 문자열도 안 들어가는 문제. type으로 상품 조회할 때는 문자열이어도 됐었다. `ENUM(["coffee", "juice", "food"])` state도 같은 enum 타입인데 `ENUM(["0", "1", "2", "3"])` 문자열을 넣으면 state: '[object Undefined]' 이런 오류가 생긴다. 숫자를 넣으면 기본값인 0이 된다.
- toString(숫자) 이렇게 메서드를 잘못 사용했다. 숫자.toString/String(숫자) 이렇게 써야 한다. 호출하는 값에 직접 적용/전달받은 인자를 변환

### (발주 상태 수정) 각 테이블의 pk가 모두 id라서 트랜잭션을 할 때 변수가 겹치는 문제

- 구조 분해 할당 하면서 식별자에 할당하기 { 식별자 = 키 } = 객체
- findByPk는 구조 분해 할당이 안 돼서 id 전역 변수?를 따로 선언했다.
- repository 에 있는 메서드는 매개변수를 갖고 service에서 호출할 때는 인자를 갖는다. 메서드의 매개변수는 인자와 같을 필요가 없다.

### (발주 상태 수정) url에 order_item_id를 넣어야 하는지

- 특정 order_item_id를 수정해야 하기 때문에 수정할 order_item_id를 명시해야 하지 않을까?
- 1번 아이템의 3번 오더 아이템 데이터를 수정하겠다

### db에 값이 있는데 찾지 못 할 때

- repository에서 모델 잘 썼는지 확인

### (발주 상태 수정) 트랜잭션 순서

- 상품 발주 상태 수정 후 발주 상태가 PENDING 에서 COMPLETED 로 변경되면 상품 amount 증가
- 상품 발주 상태 수정 후 발주 상태가 COMPLETED 에서 다른 상태로 변경되고 아이템 수량이 아이템 오더 수량보다 크거나 같으면 amount 감소

### (발주 상태 수정) 발주 완료 후 유저가 주문해서 amount 감소 후 발주 취소 하면 오류 생길 수 있음

-

### (발주 상태 수정) url에 item_id 없어도 괜찮을까

- 상품 발주 하면서 테이블에 생긴 item_id 사용하면 될 것 같다
- item_id 지우고 시도중

## (상품 주문) 어떻게 만들지

- 관련 테이블: (n)item_order_customer, (1)order_customer
- 관계 형성: (1)item : (n)item_order_customer, (1)order_customer : (n)item_order_customer
- state (default = false): state true를 서버에 보내면 주문 완료
- `option (8/4 이후) 유저가 선택한 옵션의 내역을 json 타입으로 저장`
- `price 옵션 가격이 포함된 상품의 가격`

- order_customer: 주문 번호(1번 주문)
- amount: 주문할 상품 갯수
- 아이템 하나씩 주문 하고 같은 주문 id를 트랜잭션으로 한 번에 처리
- 주문이 끝날 때 까지 생성한 주문서들은 하나의 order_customer의 id를 가짐
- 주문한 모든 상품 가격의 합을 고객에게 반환
- item_order_customer: 각 상품의 주문서(1번 주문의 커피, 식빵)
- 주문 완료 (body에 state: true) 되면 주문 id 와 전체 가격 응답

- `수정`
- 미리 할 일: item마다 option 만들기
- 커피는 extra, shot추가, hot/ice
- 음료는 extra

- 주문 번호 만들기
- 주문할 때 item 에서 아이템 이름, 가격 가져오기/option 가져오기
- 하나의 주문에 아이템 옵션과 갯수만큼 price 계산
- 모든 주문의 price 더해서 총액 만들기
- 응답 데이터: 주문 번호, 주문 아이템, 옵션, 총액

## (상품 주문) order_customer_id를 params로 받지 않고 주문 완료 됐을 때 반환만 해야할지

- order_customer_id를 params로 받으면 반환 할 때 같은 값을 반환해서 겹친다
- 여러 상품 주문 후 (상품 주문 수정) api를 통해 주문 id를 반환하면 될 것 같다

## 구조 분해 할당 식별자 사용 안되는 문제

- const { 식별자 = key } = obj; 혼공스 공부할 때는 됐는데 왜인지 지금은 안 됨
- const { key: 변수 } = obj; mdn에서 찾은 새로운 변수 이름으로 할당하기

## (상품 주문) repository, service 어느쪽에 비즈니스 로직 만들지

- 메인 로직은 service에 만든다고 배웠다
- 처음엔 repository에 데이터 베이스 메서드를 하나씩 만들어서 깔끔해 보였는데 트랜잭션을 쓸때는 특히 repository에서 데이터 베이스에 다양한 매개변수를 사용해 자주 접근하다보니 service에서는 복잡한 데이터 베이스 접근이 어렵게 느껴지는 것 같다

## (상품 주문) 한 명이 주문 하면 order_customer를 하나만 만드는 방법

- 한 명당 하나의 주문 번호
- 주문 번호는 주문이 끝나고 마지막에 한 번 만들까?
- item_order_customer를 먼저 여러 개 만들면 자동 생성되는 order_customer의 id를 어떻게 할당?
- 주문을 여러 번 하지 않게 body에서 데이터를 한 번에 받아서 처리

## 아이템, 상품 주문, 고객 주문 등 파일을 나누는 게 좋을까?

- 예전 과제에서는 유저, 게시물, 댓글 등으로 분류에 따라 확실하게 나뉘었는데 이번 과제에서는 각 기능에 따라 여러 데이터 베이스를 자주 접근하게 되는 것 같아서 파일을 나누면 중복되는 코드가 생길 것 같다
- 분류 해보면서 클래스 연습도 해볼 겸 파일을 나눠봐야겠다

## 옵션에 대하여

- 하나의 옵션에 여러 아이템이 만들어지면 다양한 옵션을 가진 많은 아이템을 만들어야 한다(차가운 커피/엑스트라, 샷 두 개 추가 커피/차가운 엑스트라 샷 세 개 추가 커피)
- 하나의 아이템에 여러 옵션을 만든다면 각 아이템에 따라 옵션을 여러개 만들어야 한다(커피: 뜨거운 기본크기 샷 없는 옵션/차가운 엑스트라 샷 추가 없는 커피)
- 하나의 아이템에 하나의 옵션을 만들면 어떤 문제가 생길지 모르겠다 (커피: 기본/아이스, 기본/엑스트라 가격, 샷 하나당 가격), (음료: 기본/아이스, 기본/엑스트라 가격, 샷 없음), (음식: 옵션 없음)
- 1:1예시 (아메리카노: 엑스트라 500, 샷 추가 300, 핫/아이스), (카푸치노: 엑스트라 600, 샷 추가 400, 핫/아이스), (수박주스: 엑스트라 800, 샷 추가 없음)

## 추가 구성

### 어떤 상태로 변경했는지 템플릿 리터럴 사용해서 자세히 응답

```javascript
res
  .status(200)
  .json({ message: `상품 발주 상태를 ${state}(으)로 수정했습니다.` });
```
