# 진행 상황

## 과제 날짜

- 7/25 과제 세팅 및 시작
- 7/26 상품 추가 api
- 7/27 상품 조회, 삭제, 수정 api
- 7/28 상품 발주, 발주 상태 수정 api
- 7/31 상품 주문 api

## API

| NAME           | METHOD   | URL                           |
| -------------- | -------- | ----------------------------- |
| 상품 생성      | `post`   | api/items                     |
| 상품 조회      | `get`    | api/items/?key=value          |
| 상품 삭제      | `delete` | api/items/:item_id            |
| 상품 수정      | `put`    | api/items/:item_id            |
| 상품 발주      | `post`   | api/items/:item_id/order_item |
| 발주 상태 수정 | `put`    | api/items/:item_id/order_item |

## 추가 기능

- readline 모듈
- transaction

## 문제

### 테이블에 따라서 어떤 데이터를 어떤 방식으로 가져오는 게 좋을지

- id는 url을 가져오는 params로 받았다
- 테이블의 주된 데이터들은 보통 body로 받았다
- 간단하게 url에서 가져올 데이터는 query로 받을 수 있다

### 레파지토리 어떻게 구성하면 좋을지

- 각각의 메서드로 구성하는 게 보기에 깔끔해 보여서 모두 나눴다
- 트랜잭션을 하면 여러 메서드를 사용하면서 에러 처리도 해야할 것 같다

### (상품 생성) 서비스의 에러 처리

- 서비스에서 throw new error를 사용해 컨트롤러에서 에러 메세지가 같으면 해당하는 응답을 보냈다. 만약 에러를 수정할 일이 생기면 서비스에 있는 에러 문구와 컨트롤러에 있는 에러 문구를 번거롭게 수정해야하는 단점도 있지만 상태 코드를 에러 메세지에 맞게 보내줄 수 있는 다른 방법을 아직 찾지 못 했다.

### (상품 조회) 전체 조회와 type별로 조회

- 처음엔 body에 type을 요청했는데 쿼리를 알게 되어서 ?type=coffee 처럼 url에 타입이 있으면 타입별로 조회하고 url에 타입이 없으면 전체 조회를 하게 만들었다

### (상품 삭제) readline을 써야할지, 쓰면 어떻게 써야 할지

- 사용자의 의사를 확인 해야 해서 readline을 써보기로 했다. 사용자가 대답한 값을 사용하려면 사용자가 대답을 한 후에 값을 받을 수 있게 반환값을 기다려서 받아야 했다. 그래서 promise를 사용해 사용자가 대답을 한 후에 값을 반환하게 만들었다.

### (상품 발주) enum 타입 state에 데이터가 안 들어가는 문제

- enum 타입을 모델과 마이그레이션에 만들 때 숫자로 만들면 에러가 생겼다. defalultValue 또한 문자열로 ('0') 바꿔줬다. type으로 상품 조회할 때는 문자열이어도 됐었다. `ENUM(["coffee", "juice", "food"])` state도 같은 enum 타입인데 `ENUM(["0", "1", "2", "3"])` 문자열을 넣으면 state: '[object Undefined]' 이런 오류가 생긴다. 숫자를 넣으면 기본값인 0이 된다.
- toString(숫자) 이렇게 메서드를 잘못 사용했다. 숫자.toString/String(숫자) 이렇게 써야 한다. 호출하는 값에 직접 적용/전달받은 인자를 변환

### (발주 상태 수정) 각 테이블의 pk가 모두 id라서 트랜잭션을 할 때 변수가 겹치는 문제

- 구조 분해 할당 하면서 식별자에 할당하기 { 식별자 = 키 } = 객체

### (발주 상태 수정) url에 order_item_id를 넣어야 하는지

- 특정 order_item_id를 수정해야 하기 때문에 수정할 order_item_id를 명시해야 하지 않을까?
- 1번 아이템의 3번 오더 아이템 데이터를 수정하겠다

### db에 값이 있는데 찾지 못 할 때

- repository에서 모델 잘 썼는지 확인

### (발주 상태 수정) 트랜잭션 순서

- 상품 발주 상태 수정 후 발주 상태가 PENDING 에서 COMPLETED 로 변경되면 상품 amount 증가
- 상품 발주 상태 수정 후 발주 상태가 COMPLETED 에서 다른 상태로 변경되고 아이템 수량이 아이템 오더 수량보다 크거나 같으면 amount 감소

### (발주 상태 수정) 발주 완료 후 유저가 주문해서 amount 감소 후 발주 취소 하면 오류 생길 수 있음

## 추가 구성

### 어떤 상태로 변경했는지 템플릿 리터럴 사용해서 자세히 응답

```javascript
res
  .status(200)
  .json({ message: `상품 발주 상태를 ${state}(으)로 수정했습니다.` });
```
